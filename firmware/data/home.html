<!DOCTYPE HTML>
<html>
<head>
  <title>BattleButBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
  <div class="container disable-double-tap-zoom">
    <br>
    <div class="row">
      <h5 style="text-align: center;">&#x1F579; BattleButBot Controller</h5>
    </div>
    <br>
    <div class="row description-box">
      <div class="col-6 color-border center-box">
        <h1 id="speed-o-meter">0.0</h1>
        <h6 id="speed-o-meter-label">(m/s)</h6>
      </div>
      <div id="arrow-container" class="col-6 color-border center-box">
      </div>
    </div>
    <div class="row" id="joystick" style="position: relative; width: 280px; height: 280px; margin: auto;">
    </div>
    <div class="row footer-box">
      <button id="action" class="col-6 button-primary">Action</button>
      <button id="config" class="col-6 button">&#x2699; Config</button>
    </div>
    <div class="row tiny-text classic-margin" id="console">
      &#x2139; CONSOLE
    </div>
  </div>

<script>
  // Joy Stick Library
  let StickStatus={xPosition:0,yPosition:0,x:0,y:0,cardinalDirection:"C"};var JoyStick=function(t,e,i){var o=void 0===(e=e||{}).title?"joystick":e.title,n=void 0===e.width?0:e.width,a=void 0===e.height?0:e.height,r=void 0===e.internalFillColor?"#0096FF":e.internalFillColor,c=void 0===e.internalLineWidth?2:e.internalLineWidth,s=void 0===e.internalStrokeColor?"#FFFFFF":e.internalStrokeColor,d=void 0===e.externalLineWidth?2:e.externalLineWidth,$=void 0===e.externalStrokeColor?"#000000":e.externalStrokeColor,u=void 0===e.autoReturnToCenter||e.autoReturnToCenter;i=i||function(t){};var h=document.getElementById(t);h.style.touchAction="none";var S=document.createElement("canvas");S.id=o,0===n&&(n=h.clientWidth),0===a&&(a=h.clientHeight),S.width=n,S.height=a,h.appendChild(S);var l=S.getContext("2d"),f=0,k=2*Math.PI,_=(S.width-(S.width/2+10))/2,g=_+5,x=_+30,v=S.width/2,P=S.height/2,C=S.width/10,p=-1*C,y=S.height/10,w=-1*y,L=v,F=P;function m(){l.beginPath(),l.arc(v,P,x,0,k,!1),l.lineWidth=d,l.strokeStyle=$,l.stroke()}function E(){l.beginPath(),L<_&&(L=g),L+_>S.width&&(L=S.width-g),F<_&&(F=g),F+_>S.height&&(F=S.height-g),l.arc(L,F,_,0,k,!1);var t=l.createRadialGradient(v,P,5,v,P,200);t.addColorStop(0,r),t.addColorStop(1,s),l.fillStyle=t,l.fill(),l.lineWidth=c,l.strokeStyle=s,l.stroke()}"ontouchstart"in document.documentElement?(S.addEventListener("touchstart",function t(e){f=1,T=e.targetTouches[0].identifier},!1),document.addEventListener("touchmove",function t(e){1===f&&e.targetTouches[0].target===S&&(L=e.targetTouches[0].pageX,F=e.targetTouches[0].pageY,"BODY"===S.offsetParent.tagName.toUpperCase()?(L-=S.offsetLeft,F-=S.offsetTop):(L-=S.offsetParent.offsetLeft,F-=S.offsetParent.offsetTop),l.clearRect(0,0,S.width,S.height),m(),E(),StickStatus.xPosition=L,StickStatus.yPosition=F,StickStatus.x=(100*((L-v)/g)).toFixed(),StickStatus.y=(-(100*((F-P)/g)*1)).toFixed(),StickStatus.cardinalDirection=D(),i(StickStatus))},!1),document.addEventListener("touchend",function t(e){e.changedTouches[0].identifier===T&&(f=0,u&&(L=v,F=P),l.clearRect(0,0,S.width,S.height),m(),E(),StickStatus.xPosition=L,StickStatus.yPosition=F,StickStatus.x=(100*((L-v)/g)).toFixed(),StickStatus.y=(-(100*((F-P)/g)*1)).toFixed(),StickStatus.cardinalDirection=D(),i(StickStatus))},!1)):(S.addEventListener("mousedown",W,!1),document.addEventListener("mousemove",function t(e){1===f&&(L=e.pageX,F=e.pageY,"BODY"===S.offsetParent.tagName.toUpperCase()?(L-=S.offsetLeft,F-=S.offsetTop):(L-=S.offsetParent.offsetLeft,F-=S.offsetParent.offsetTop),l.clearRect(0,0,S.width,S.height),m(),E(),StickStatus.xPosition=L,StickStatus.yPosition=F,StickStatus.x=(100*((L-v)/g)).toFixed(),StickStatus.y=(-(100*((F-P)/g)*1)).toFixed(),StickStatus.cardinalDirection=D(),i(StickStatus))},!1),document.addEventListener("mouseup",function t(e){f=0,u&&(L=v,F=P),l.clearRect(0,0,S.width,S.height),m(),E(),StickStatus.xPosition=L,StickStatus.yPosition=F,StickStatus.x=(100*((L-v)/g)).toFixed(),StickStatus.y=(-(100*((F-P)/g)*1)).toFixed(),StickStatus.cardinalDirection=D(),i(StickStatus)},!1)),m(),E();let T=null;function W(t){f=1}function D(){let t="",e=L-v,i=F-P;return i>=w&&i<=y&&(t="C"),i<w&&(t="N"),i>y&&(t="S"),e<p&&("C"===t?t="W":t+="W"),e>C&&("C"===t?t="E":t+="E"),t}this.GetWidth=function(){return S.width},this.GetHeight=function(){return S.height},this.GetPosX=function(){return L},this.GetPosY=function(){return F},this.GetX=function(){return(100*((L-v)/g)).toFixed()},this.GetY=function(){return(-(100*((F-P)/g)*1)).toFixed()},this.GetDir=function(){return D()}};

  window.onload = function () {
    // Fetch elements
    var log = document.getElementById("console");
    var speedOMeter = document.getElementById("speed-o-meter");
    var action = document.getElementById("action");
    var config = document.getElementById("config");
    var arrowContainer = document.getElementById("arrow-container");
    const joystick = document.getElementById("joystick");
    var token = false;

    // Fill arrow svgs.
    const arrowFront = '<svg role="img" xmlns="http://www.w3.org/2000/svg" width="56px" height="56px" viewBox="0 0 24 24" aria-labelledby="arrowUpIconTitle" stroke="#3CA0FA" stroke-width="2.142857142857143" stroke-linecap="round" stroke-linejoin="miter" fill="none" color="#3CA0FA"> <title id="arrowUpIconTitle">Arrow Up</title> <path d="M18 9l-6-6-6 6"/> <path d="M12 21V4"/> <path stroke-linecap="round" d="M12 3v1"/> </svg>';
    const arrowRight = '<svg role="img" xmlns="http://www.w3.org/2000/svg" width="56px" height="56px" viewBox="0 0 24 24" aria-labelledby="arrowRightTopIconTitle" stroke="#3CA0FA" stroke-width="2.142857142857143" stroke-linecap="round" stroke-linejoin="miter" fill="none" color="#3CA0FA"> <title id="arrowRightTopIconTitle">Arrow Right Top</title> <path d="M19 13V5h-8"/> <path stroke-linecap="round" d="M19 5l-1 1"/> <path d="M18 6L5 19"/> </svg>';
    const arrowLeft = '<svg role="img" xmlns="http://www.w3.org/2000/svg" width="56px" height="56px" viewBox="0 0 24 24" aria-labelledby="arrowLeftTopIconTitle" stroke="#3CA0FA" stroke-width="2.142857142857143" stroke-linecap="round" stroke-linejoin="miter" fill="none" color="#3CA0FA"> <title id="arrowLeftTopIconTitle"/> <path d="M5 13V5h8"/> <path stroke-linecap="round" d="M5 5l1 1"/> <path d="M6 6l13 13"/> </svg>';
    const arrowBack = '<svg role="img" xmlns="http://www.w3.org/2000/svg" width="56px" height="56px" viewBox="0 0 24 24" aria-labelledby="arrowDownIconTitle" stroke="#3CA0FA" stroke-width="2.142857142857143" stroke-linecap="round" stroke-linejoin="miter" fill="none" color="#3CA0FA"> <title id="arrowDownIconTitle">Arrow Down</title> <path d="M6 15l6 6 6-6"/> <path d="M12 3v17"/> <path stroke-linecap="round" d="M12 21v-1"/> </svg>';

    // Prevent tap and hold text selection.
    // ['touchstart', 'touchend', 'touchmove', 'touchcancel'].forEach(function(e){
    //   joystick.addEventListener(e, ev => { ev.preventDefault(); });
    // });

    action.addEventListener('click', e => {
      token = false;
      _request("/action");
    });
    config.addEventListener('click', e => {
      if (token) {
        return;
      }
      window.location.href = 'config';
    });

    var Joy = new JoyStick('joystick', {}, function(thumb) {
      if (thumb.x != 0 && thumb.y != 0 && token) {
        return;
      }
      token = true;
      _updateArrowContainer(thumb.y, thumb.x)
      _updateSpeedMeter(thumb.y, thumb.x);
      _request("/update?x=" + thumb.x + "&y=" + thumb.y);
    });

    function _request(path) {
      const xhr = new XMLHttpRequest();
      xhr.onload = () => {
        log.innerText = xhr.status == 200 ? path + ' OK' : "404";
        token = false;
      };
      xhr.ontimeout = () => {
        token = false;
        log.innerText = "Timeout on XML request!";
      };
      xhr.onerror = () => {
        token = false;
        log.innerText = "Error on XML request!";
      };
      xhr.open("GET", path, true);
      xhr.send();
    }

    function _updateSpeedMeter(speed, dir) {
      speedOMeter.innerText = ((speed / (Math.abs(dir) + 0.001)) % 2).toFixed(1);
    }

    function _updateArrowContainer(speed, dir) {
      if (speed == 0 && dir == 0) {
        arrowContainer.innerHTML = '';
      } else if (speed > 0) {
        if (Math.abs(dir) < 20) {
          arrowContainer.innerHTML = arrowFront;
        } else {
          if (dir > 0) {
            arrowContainer.innerHTML = arrowRight;
          } else {
            arrowContainer.innerHTML = arrowLeft;
          }
        }
      } else {
        arrowContainer.innerHTML = arrowBack;
      }
    }
  }
</script>
</body>
</html>

<!DOCTYPE HTML>
<html>
<head>
  <title>BubbleButBot</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    h1,h2,h3{letter-spacing:-.1rem}body,h6{line-height:1.6}ol,p,ul{margin-top:0}.container{position:relative;width:350px;max-width:350px;margin:0 auto;padding:0 20px;box-sizing:border-box}.column,.columns{width:100%;float:left;box-sizing:border-box}html{background-color:#f5f5f5;font-size:62.5%}body{font-size:1.5em;font-weight:400;font-family:Raleway,HelveticaNeue,"Helvetica Neue",Helvetica,Arial,sans-serif;color:#222;overflow:hidden;-webkit-touch-callout:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:2rem;font-weight:300}h1{font-size:4rem;line-height:1.2}h2{font-size:3.6rem;line-height:1.25}h3{font-size:3rem;line-height:1.3}h4{font-size:2.4rem;line-height:1.35;letter-spacing:-.08rem}h5{font-size:1.8rem;line-height:1.5;letter-spacing:-.05rem}h6{font-size:1.5rem;letter-spacing:0}a{color:#1eaedb}a:hover{color:#0fa0ce}.button,button,input[type=button],input[type=reset],input[type=submit]{display:inline-block;height:38px;padding:0 30px;color:#555;text-align:center;font-size:11px;font-weight:600;line-height:38px;letter-spacing:.1rem;text-transform:uppercase;text-decoration:none;white-space:nowrap;background-color:transparent;border-radius:4px;border:1px solid #bbb;cursor:pointer;box-sizing:border-box}ol,td:first-child,th:first-child,ul{padding-left:0}.button:focus,.button:hover,button:focus,button:hover,input[type=button]:focus,input[type=button]:hover,input[type=reset]:focus,input[type=reset]:hover,input[type=submit]:focus,input[type=submit]:hover{color:#333;border-color:#888;outline:0}.button.button-primary,button.button-primary,input[type=button].button-primary,input[type=reset].button-primary,input[type=submit].button-primary{color:#fff;background-color:#33c3f0;border-color:#33c3f0}.button.button-primary:focus,.button.button-primary:hover,button.button-primary:focus,button.button-primary:hover,input[type=button].button-primary:focus,input[type=button].button-primary:hover,input[type=reset].button-primary:focus,input[type=reset].button-primary:hover,input[type=submit].button-primary:focus,input[type=submit].button-primary:hover{color:#fff;background-color:#1eaedb;border-color:#1eaedb}input[type=email],input[type=number],input[type=password],input[type=search],input[type=tel],input[type=text],input[type=url],select,textarea{height:38px;padding:6px 10px;background-color:#fff;border:1px solid #d1d1d1;border-radius:4px;box-shadow:none;box-sizing:border-box}input[type=email],input[type=number],input[type=password],input[type=search],input[type=tel],input[type=text],input[type=url],textarea{-webkit-appearance:none;-moz-appearance:none;appearance:none}textarea{min-height:65px;padding-top:6px;padding-bottom:6px}input[type=email]:focus,input[type=number]:focus,input[type=password]:focus,input[type=search]:focus,input[type=tel]:focus,input[type=text]:focus,input[type=url]:focus,select:focus,textarea:focus{border:1px solid #33c3f0;outline:0}label,legend{display:block;margin-bottom:.5rem;font-weight:600}fieldset{padding:0;border-width:0}input[type=checkbox],input[type=radio]{display:inline}label>.label-body{display:inline-block;margin-left:.5rem;font-weight:400}ul{list-style:circle inside}ol{list-style:decimal inside}ol ol,ol ul,ul ol,ul ul{margin:1.5rem 0 1.5rem 3rem;font-size:90%}.button,button,li{margin-bottom:1rem}td,th{padding:12px 15px;text-align:left;border-bottom:1px solid #e1e1e1}td:last-child,th:last-child{padding-right:0}fieldset,input,select,textarea{margin-bottom:1.5rem}blockquote,dl,figure,form,ol,p,pre,table,ul{margin-bottom:2.5rem}hr{margin-top:3rem;margin-bottom:3.5rem;border-width:0;border-top:1px solid #e1e1e1}.container:after,.row:after,.u-cf{content:"";display:table;clear:both}.one.columns{width:4.66666666667%}.two.columns{width:13.3333333333%}.three.columns{width:22%}.four.columns{width:30.6666666667%}.five.columns{width:39.3333333333%}.six.columns{width:48%}.seven.columns{width:56.6666666667%}.eight.columns{width:65.3333333333%}.nine.columns{width:74%}.ten.columns{width:82.6666666667%}.eleven.columns{width:91.3333333333%}.twelve.columns{width:100%;margin-left:0}
    .vertical-align-row {
      display: flex;
      align-items: center;
    }

    #speed-o-meter {
      text-align: right;
      margin-right: 5px;
      font-size: 5em;
    }

    #speed-o-meter-label{
      text-align: left;
      margin-left: 5px;
    }

    #console-row {
      width: 100%;
      position: fixed;
      bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <br>
    <div class="row">
      <h4 style="text-align: center;">&#x1F579; BubbleButBot Controller</h4>
    </div>
    <br>
    <div class="row vertical-align-row">
      <div class="eight columns">
        <h1 id="speed-o-meter">0.0</h1>
      </div>
      <div class="four columns">
        <h6 id="speed-o-meter-label">(m/s)</h6>
      </div>
    </div>
    <br>
    <div class="row">
      <button id="action" class="button-primary">Action</button>
    </div>
    <div class="row vertical-align-row " id="console-row">
      <div class="six columns">
        <button class="button">&#x2699; Config</button>
      </div>
      <div class="six columns">
        <p class="console" id="console"><small>&#x2139; CONSOLE</small></p>
      </div>
    </div>
  </div>
  <div style="position: fixed; top: 0px; left: 0px; right: 0px; height: 100vh;">
    <div id="joystick" style="position: relative; width: 200px; height: 200px; margin: auto; top: 50%;"></div>
  </div>

<script>
  let StickStatus={xPosition:0,yPosition:0,x:0,y:0,cardinalDirection:"C"};var JoyStick=function(t,e,i){var o=void 0===(e=e||{}).title?"joystick":e.title,n=void 0===e.width?0:e.width,a=void 0===e.height?0:e.height,r=void 0===e.internalFillColor?"#0096FF":e.internalFillColor,c=void 0===e.internalLineWidth?2:e.internalLineWidth,s=void 0===e.internalStrokeColor?"#FFFFFF":e.internalStrokeColor,d=void 0===e.externalLineWidth?2:e.externalLineWidth,$=void 0===e.externalStrokeColor?"#000000":e.externalStrokeColor,u=void 0===e.autoReturnToCenter||e.autoReturnToCenter;i=i||function(t){};var h=document.getElementById(t);h.style.touchAction="none";var S=document.createElement("canvas");S.id=o,0===n&&(n=h.clientWidth),0===a&&(a=h.clientHeight),S.width=n,S.height=a,h.appendChild(S);var l=S.getContext("2d"),f=0,k=2*Math.PI,_=(S.width-(S.width/2+10))/2,g=_+5,x=_+30,v=S.width/2,P=S.height/2,C=S.width/10,p=-1*C,y=S.height/10,w=-1*y,L=v,F=P;function m(){l.beginPath(),l.arc(v,P,x,0,k,!1),l.lineWidth=d,l.strokeStyle=$,l.stroke()}function E(){l.beginPath(),L<_&&(L=g),L+_>S.width&&(L=S.width-g),F<_&&(F=g),F+_>S.height&&(F=S.height-g),l.arc(L,F,_,0,k,!1);var t=l.createRadialGradient(v,P,5,v,P,200);t.addColorStop(0,r),t.addColorStop(1,s),l.fillStyle=t,l.fill(),l.lineWidth=c,l.strokeStyle=s,l.stroke()}"ontouchstart"in document.documentElement?(S.addEventListener("touchstart",function t(e){f=1,T=e.targetTouches[0].identifier},!1),document.addEventListener("touchmove",function t(e){1===f&&e.targetTouches[0].target===S&&(L=e.targetTouches[0].pageX,F=e.targetTouches[0].pageY,"BODY"===S.offsetParent.tagName.toUpperCase()?(L-=S.offsetLeft,F-=S.offsetTop):(L-=S.offsetParent.offsetLeft,F-=S.offsetParent.offsetTop),l.clearRect(0,0,S.width,S.height),m(),E(),StickStatus.xPosition=L,StickStatus.yPosition=F,StickStatus.x=(100*((L-v)/g)).toFixed(),StickStatus.y=(-(100*((F-P)/g)*1)).toFixed(),StickStatus.cardinalDirection=D(),i(StickStatus))},!1),document.addEventListener("touchend",function t(e){e.changedTouches[0].identifier===T&&(f=0,u&&(L=v,F=P),l.clearRect(0,0,S.width,S.height),m(),E(),StickStatus.xPosition=L,StickStatus.yPosition=F,StickStatus.x=(100*((L-v)/g)).toFixed(),StickStatus.y=(-(100*((F-P)/g)*1)).toFixed(),StickStatus.cardinalDirection=D(),i(StickStatus))},!1)):(S.addEventListener("mousedown",W,!1),document.addEventListener("mousemove",function t(e){1===f&&(L=e.pageX,F=e.pageY,"BODY"===S.offsetParent.tagName.toUpperCase()?(L-=S.offsetLeft,F-=S.offsetTop):(L-=S.offsetParent.offsetLeft,F-=S.offsetParent.offsetTop),l.clearRect(0,0,S.width,S.height),m(),E(),StickStatus.xPosition=L,StickStatus.yPosition=F,StickStatus.x=(100*((L-v)/g)).toFixed(),StickStatus.y=(-(100*((F-P)/g)*1)).toFixed(),StickStatus.cardinalDirection=D(),i(StickStatus))},!1),document.addEventListener("mouseup",function t(e){f=0,u&&(L=v,F=P),l.clearRect(0,0,S.width,S.height),m(),E(),StickStatus.xPosition=L,StickStatus.yPosition=F,StickStatus.x=(100*((L-v)/g)).toFixed(),StickStatus.y=(-(100*((F-P)/g)*1)).toFixed(),StickStatus.cardinalDirection=D(),i(StickStatus)},!1)),m(),E();let T=null;function W(t){f=1}function D(){let t="",e=L-v,i=F-P;return i>=w&&i<=y&&(t="C"),i<w&&(t="N"),i>y&&(t="S"),e<p&&("C"===t?t="W":t+="W"),e>C&&("C"===t?t="E":t+="E"),t}this.GetWidth=function(){return S.width},this.GetHeight=function(){return S.height},this.GetPosX=function(){return L},this.GetPosY=function(){return F},this.GetX=function(){return(100*((L-v)/g)).toFixed()},this.GetY=function(){return(-(100*((F-P)/g)*1)).toFixed()},this.GetDir=function(){return D()}};
  window.onload = function () {
    var log = document.getElementById("console");
    var speedOMeter = document.getElementById("speed-o-meter");
    var action = document.getElementById("action");
    var token = false;

    document.addEventListener('touchstart', e => { e.preventDefault(); })
    document.addEventListener('click', e => {
      if (token) {
        return;
      }
      _request("GET", "/action");
    });

    var Joy = new JoyStick('joystick', {}, function(thumb) {
      if (thumb.x != 0 && thumb.y != 0 && token) {
        return;
      }
      token = true;
      speedOMeter.innerText = _convertToMetersPerSecond(thumb.y, thumb.x);
      _request("GET", "/update?x=" + thumb.x + "&y=" + thumb.y);
    });

    function _request(method, path) {
      const xhr = new XMLHttpRequest();
      xhr.onload = () => {
        log.innerText = xhr.status == 200 ? path + ' OK' : "404";
        token = false;
      };
      xhr.ontimeout = () => {
        token = false;
        log.innerText = "Timeout on XML request!";
      };
      xhr.onerror = () => {
        token = false;
        log.innerText = "Error on XML request!";
      };
      xhr.open(method, path, true);
      xhr.send();
    }

    function _convertToMetersPerSecond(speed, dir) {
      return ((speed / (Math.abs(dir) + 0.001)) % 2).toFixed(1);
    }
  }
</script>
</body>
</html>
